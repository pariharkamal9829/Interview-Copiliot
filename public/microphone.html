<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Audio Transcription - Interview Copilot</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .status { padding: 10px; border-radius: 4px; margin-bottom: 15px; font-weight: bold; text-align: center; }
        .recording { background-color: #f8d7da; color: #721c24; }
        .stopped { background-color: #d4edda; color: #155724; }
        .transcription { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; min-height: 200px; border-radius: 4px; }
        button { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .record-btn { background-color: #dc3545; }
        .interim { color: #6c757d; font-style: italic; }
        .final { color: #333; font-weight: bold; }
        .controls { text-align: center; margin: 20px 0; }
        .upload-area { border: 2px dashed #ddd; padding: 20px; text-align: center; border-radius: 4px; margin: 10px 0; }
        .upload-area.dragover { border-color: #007bff; background-color: #f8f9fa; }
    </style>
</head>
<body>
    <h1>üé§ Live Audio Transcription</h1>
    
    <div class="container">
        <div id="status" class="status stopped">Ready to Record</div>
        
        <div class="controls">
            <button id="recordBtn" onclick="toggleRecording()">üî¥ Start Recording</button>
            <button id="clearBtn" onclick="clearTranscription()">üóëÔ∏è Clear</button>
            <button onclick="connect()">üîó Connect to Server</button>
        </div>

        <div>
            <label>Language:</label>
            <select id="languageSelect">
                <option value="en">English</option>
                <option value="es">Spanish</option>
                <option value="fr">French</option>
                <option value="de">German</option>
                <option value="it">Italian</option>
                <option value="pt">Portuguese</option>
                <option value="zh">Chinese</option>
                <option value="ja">Japanese</option>
                <option value="ko">Korean</option>
            </select>
        </div>
    </div>

    <div class="container">
        <h3>üìù Live Transcription</h3>
        <div id="transcription" class="transcription">
            Transcribed text will appear here...
        </div>
    </div>

    <div class="container">
        <h3>üìÅ Upload Audio File</h3>
        <div id="uploadArea" class="upload-area">
            <p>Drag & drop an audio file here or click to select</p>
            <input type="file" id="fileInput" accept="audio/*" style="display: none;">
            <button onclick="document.getElementById('fileInput').click()">Choose File</button>
        </div>
        <div id="uploadResult"></div>
    </div>

    <script>
        let socket = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let recordingStartTime = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupFileUpload();
            checkMicrophonePermission();
        });

        // Connect to Socket.IO server
        function connect() {
            socket = io();
            
            socket.on('connect', () => {
                console.log('Connected to server');
                updateStatus('Connected to server', 'stopped');
            });

            socket.on('transcription-result', (data) => {
                displayTranscription(data.text, data.isFinal, data.confidence);
            });

            socket.on('live-transcription', (data) => {
                displayTranscription(data.text, data.isFinal, data.confidence);
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from server');
                updateStatus('Disconnected', 'stopped');
            });
        }

        // Check microphone permission
        async function checkMicrophonePermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                console.log('Microphone permission granted');
            } catch (error) {
                console.error('Microphone permission denied:', error);
                alert('Microphone permission is required for live transcription');
            }
        }

        // Toggle recording
        async function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        // Start recording
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });

                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });

                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    sendAudioForTranscription(audioBlob);
                };

                mediaRecorder.start(1000); // Collect data every second
                isRecording = true;
                recordingStartTime = Date.now();

                updateStatus('üî¥ Recording...', 'recording');
                document.getElementById('recordBtn').textContent = '‚èπÔ∏è Stop Recording';

            } catch (error) {
                console.error('Error starting recording:', error);
                alert('Error accessing microphone: ' + error.message);
            }
        }

        // Stop recording
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }

            isRecording = false;
            updateStatus('Processing...', 'stopped');
            document.getElementById('recordBtn').textContent = 'üî¥ Start Recording';
        }

        // Send audio for transcription
        async function sendAudioForTranscription(audioBlob) {
            try {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');
                formData.append('language', document.getElementById('languageSelect').value);

                const response = await fetch('/api/transcribe', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    displayTranscription(result.text, true, result.confidence || 0.95);
                    
                    // Send via Socket.IO if connected
                    if (socket && socket.connected) {
                        socket.emit('transcription', {
                            text: result.text,
                            confidence: result.confidence || 0.95,
                            isFinal: true,
                            language: result.language
                        });
                    }
                } else {
                    console.error('Transcription error:', result.error);
                    displayTranscription('‚ùå Error: ' + result.error, true, 0);
                }

                updateStatus('Ready to Record', 'stopped');

            } catch (error) {
                console.error('Error sending audio:', error);
                displayTranscription('‚ùå Network error: ' + error.message, true, 0);
                updateStatus('Ready to Record', 'stopped');
            }
        }

        // Display transcription
        function displayTranscription(text, isFinal, confidence) {
            const transcriptionDiv = document.getElementById('transcription');
            const timestamp = new Date().toLocaleTimeString();
            
            const className = isFinal ? 'final' : 'interim';
            const confidenceText = confidence ? ` (${Math.round(confidence * 100)}%)` : '';
            
            const transcriptionHtml = `
                <div class="${className}">
                    <span style="color: #666; font-size: 0.8em;">[${timestamp}]</span>
                    ${text}${confidenceText}
                </div>
            `;
            
            if (isFinal) {
                transcriptionDiv.innerHTML += transcriptionHtml;
            } else {
                // Replace last interim result
                const interim = transcriptionDiv.querySelector('.interim:last-child');
                if (interim) {
                    interim.outerHTML = transcriptionHtml;
                } else {
                    transcriptionDiv.innerHTML += transcriptionHtml;
                }
            }
            
            transcriptionDiv.scrollTop = transcriptionDiv.scrollHeight;
        }

        // Update status
        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        // Clear transcription
        function clearTranscription() {
            document.getElementById('transcription').innerHTML = 'Transcribed text will appear here...';
        }

        // File upload setup
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                }
            });
        }

        // Handle file upload
        async function handleFileUpload(file) {
            const resultDiv = document.getElementById('uploadResult');
            resultDiv.innerHTML = '‚è≥ Transcribing uploaded file...';

            try {
                const formData = new FormData();
                formData.append('audio', file);
                formData.append('language', document.getElementById('languageSelect').value);

                const response = await fetch('/api/transcribe', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div style="background: #d4edda; padding: 10px; border-radius: 4px; margin: 10px 0;">
                            <strong>‚úÖ File transcribed successfully!</strong><br>
                            <em>Duration: ${result.duration}s | Language: ${result.language}</em><br>
                            <strong>Text:</strong> ${result.text}
                        </div>
                    `;
                    
                    // Add to main transcription area
                    displayTranscription(`[File Upload] ${result.text}`, true, 1.0);
                } else {
                    resultDiv.innerHTML = `
                        <div style="background: #f8d7da; padding: 10px; border-radius: 4px; margin: 10px 0;">
                            <strong>‚ùå Error:</strong> ${result.error}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="background: #f8d7da; padding: 10px; border-radius: 4px; margin: 10px 0;">
                        <strong>‚ùå Network Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // Auto-connect on load
        setTimeout(connect, 1000);
    </script>
</body>
</html>
